---
title: "Explore Census2016 Package"
output: html_notebook
---

It looks like Raustats might not be what I am looking for to get SLA level census data quickly. Let's try Census2016 from Hugh Parsonage.

```{r, warning=FALSE, echo=FALSE, error=FALSE, message=FALSE}
library(tidyverse)
library(Census2016)
library(eechidna)
library(RColorBrewer)
```

```{r}
full_2016_census <- Census2016_wide_by_SA2_year %>% 
  filter(year == '2016' )
head(full_2016_census)
```

Yes - this is what I need.

Loading other tables

```{r}
ancestories_2016 <- Census2016_ancestories %>% 
  filter(year == '2016' )
countries_of_birth_2016 <- Census2016_countries_of_birth %>% 
  filter(year == '2016' )
languages_2016 <- Census2016_languages %>% 
  filter(year == '2016' )
religions_2016 <- Census2016_religions %>% 
  filter(year == '2016' )
```

# Feature Engineering

Each of the four variables ancestory, country of birth, languages and religions are quite granular, and it may make sense to look at these variables at a lower level of granularity. 

Ancestory:
```{r}
download.file('https://www.abs.gov.au/AUSSTATS/subscriber.nsf/log?openagent&12490do0001_201912.xls&1249.0&Data%20Cubes&674EFC4CA0A3D8FDCA2584D30012B905&0&2019&18.12.2019&Latest', './Data/ancestry_classification.xls', method = 'libcurl')

ancestry_classification_4dig <- 
  readxl::read_xls('./Data/ancestry_classification.xls', sheet = 'Table 1.3', 
                   skip = 7, col_names = c('X1', 'X2', 'Ancestory_Code_4', 'Ancestory')) %>% 
  filter(!is.na(Ancestory)) %>% 
  select(Ancestory_Code_4, Ancestory)

ancestry_classification_1dig <- 
  readxl::read_xls('./Data/ancestry_classification.xls', sheet = 'Table 1.1', 
                   skip = 5, col_names = c('Ancestory_Code_1', 'Ancestory_Group'))%>% 
  filter(!is.na(Ancestory_Group))
```

Country of birth
```{r}
download.file('https://www.abs.gov.au/ausstats/subscriber.nsf/log?openagent&sacc_12690do0001_201903.xls&1269.0&Data%20Cubes&480BD730AF42D515CA2583BD007707C5&0&2016&15.03.2019&Latest', './Data/country_classification.xls', method = 'libcurl')

country_classification_4dig <- 
  readxl::read_xls('./Data/country_classification.xls', sheet = 'Table 1.3', 
                   skip = 7, col_names = c('X1', 'X2', 'Country_Code_4', 'Country')) %>% 
  filter(!is.na(Country)) %>% 
  select(-X1, -X2)

country_classification_2dig <- 
  readxl::read_xls('./Data/country_classification.xls', sheet = 'Table 1.2', 
                   skip = 6, col_names = c('X1', 'Country_Code_2', 'Country_Name_2')) %>% 
  filter(!is.na(Country_Name_2)) %>% 
  select(-X1)

country_classification_1dig <- 
  readxl::read_xls('./Data/country_classification.xls', sheet = 'Table 1.1', 
                   skip = 5, col_names = c('Country_Code_1', 'Country_Group')) %>% 
  filter(!is.na(Country_Group))
```

Language
```{r}
download.file('https://www.abs.gov.au/AUSSTATS/subscriber.nsf/log?openagent&ASCL_12670DO0001_201703.xls&1267.0&Data%20Cubes&F84620CF6E13F7E8CA257FF1001E68A7&0&2016&28.03.2017&Latest', './Data/language_classification.xls', method = 'libcurl')

language_classification_4dig <- 
  readxl::read_xls('./Data/language_classification.xls', sheet = 'Table 1.3', 
                   skip = 8, col_names = c('X1', 'X2', 'X3', 'X4', 'Language_Code_3', 'Language')) %>% 
  filter(!is.na(Language)) %>% 
  select(-X1, -X2, -X3, -X4)

language_classification_1dig <- 
  readxl::read_xls('./Data/language_classification.xls', sheet = 'Table 1.1', 
                   skip = 5, col_names = c('Language_Code_1', 'Language_Group')) %>% 
  filter(!is.na(Language_Group))
```

Religion
```{r}
download.file('https://www.abs.gov.au/AUSSTATS/subscriber.nsf/log?openagent&ASCRG_12660DO0001_201707.xls&1266.0&Data%20Cubes&B3EAFE3FE6180D37CA257FF1001E673C&0&2016&14.07.2017&Latest', './Data/religion_classification.xls', method = 'libcurl')

religion_classification_3dig <- 
  readxl::read_xls('./Data/religion_classification.xls', sheet = 'Table 1.2', 
                   skip = 6, col_names = c('X1', 'Religion_Code_3', 'Religion')) %>% 
  filter(!is.na(Religion)) %>% 
  select(-X1)

religion_classification_1dig <- 
  readxl::read_xls('./Data/religion_classification.xls', sheet = 'Table 1.1', 
                   skip = 5, col_names = c('Religion_Code_1', 'Religion_Group')) %>% 
  filter(!is.na(Religion_Group))
```




# Combine with election data


Aggregate at the SA2 level - add unless variable contains median, average, persons_per_bedroom
```{r}
census_2016_all_vars <- Census2016_wide_by_SA2_year %>% 
  filter(year == '2016') %>% 
  rowwise() %>% 
  mutate(sa2_id = paste0(substr(sa2_code, 1, 1), substr(sa2_code, 6, 9))) %>% 
  filter(isMissing == FALSE)


census_2016_means <- census_2016_all_vars %>% 
  select(median_age, median_household_income, average_household_size, 
         persons_per_bedroom, median_weekly_rent, median_annual_mortgage, sa2_id) %>% 
  group_by(sa2_id) %>% 
  summarise_all(mean, na.rm = TRUE)

census_2016_counts <- census_2016_all_vars %>% 
  select(n_dwellings, persons, female, male, 
         married_persons, married_females, married_males, defacto_persons, 
         defacto_females, defacto_males, notmarried_persons, 
         notmarried_females, notmarried_males, indig_persons, 
         indig_males, indig_females, non_indig_persons, 
         non_indig_females, non_indig_males, not_stated_indig_persons, 
         not_stated_indig_males, not_stated_indig_females, 
         born_in_australia, born_overseas, country_not_stated, 
         separate_house, flat_or_unit, housing_other_or_not_stated, semi_or_townhouse, 
         dwelling_owned_outright, dwelling_owned_mortgage, dwelling_other_or_not_stated,
         dwelling_rented, sa2_id) %>% 
  group_by(sa2_id) %>% 
  summarise_all(sum, na.rm = TRUE)
```


So what I need is weighted demographic data for each of the polling places based on the number of people from each SLA2 who voted at the polling place. Since we don't know who voted where, and who can vote at all, we are making the naive assumptions that 
* Voters at each SLA are similar
* Voters are representitive of census respondents at the SLA2 level.

Download and load polling places by SA1
```{r}

download.file('https://www.aec.gov.au/Elections/Federal_Elections/2016/files/polling-place-by-sa1s-2016.xlsx', './Data/polling-place-by-sa1s-2016.xlsx', method = 'libcurl')

polling_place_data <- readxl::read_xlsx('./Data/polling-place-by-sa1s-2016.xlsx')

# library(repmis)
# 
# centroids <- load("./Data/centroids_sa1_2001.rda")
# alloc_elec_16 <- allocate_electorate(centroids_sa1_2011, census_year = 2016, election_year = 2016)
```


Aggregate polling place data to SA2

```{r}
polling_place_sa2 <- polling_place_data %>% 
  mutate(sa2_id = floor(SA1_id / 100)) %>% 
  group_by(year, state_ab, div_nm, pp_id, pp_nm, sa2_id) %>% 
  summarise(votes = sum(votes))

```

Combine with demographic data and aggregate

```{r}
polling_place_demog <- polling_place_sa2 %>% 
  mutate(sa2_id = as.character(sa2_id)) %>% 
  inner_join(census_2016_all_vars)

polling_place_demog_means <- polling_place_demog %>% 
  select(year, state_ab, div_nm, pp_id, pp_nm, sa2_id, votes,
         median_age, median_household_income, average_household_size, 
         persons_per_bedroom, median_weekly_rent, median_annual_mortgage) %>% 
  group_by(year, state_ab, div_nm, pp_id, pp_nm) %>% 
  summarise_at(vars(median_age, median_household_income, 
                    average_household_size, persons_per_bedroom, median_weekly_rent, 
                    median_annual_mortgage), funs(weighted.mean(., w=votes)))
```
Add in 2pp at the polling booth level
```{r}
election_2pp <- twoparty_pollingbooth_download() 

```
```{r}
polling_place_2pp <- polling_place_demog_means %>% 
  group_by() %>% 
  rename(StateAb = state_ab,
         DivisionNm = div_nm,
         PollingPlace = pp_nm,
         PollingPlaceID = pp_id) %>% 
  mutate(DivisionNm = toupper(DivisionNm),
         PollingPlace = toupper(PollingPlace)) %>% 
  left_join(election_2pp %>% 
              filter(year == 2016))
```

Check for missing data

```{r}
polling_place_2pp %>% 
  summarise_all(funs(sum(is.na(.))))
```
Which booths are null?

```{r}
polling_place_2pp %>% 
  filter(is.na(TotalVotes)) %>% 
  tabyl(PollingPlace)
```

So the Absent, Postals, Pre-Poll and Provisional votes aren't in this table. Let's come back to those... 

```{r}
polling_place_2pp %>% 
  summarise_all(funs(sum(is.null(.))))
```

Remove the rows with NAs

```{r}
polling_place_2pp_clean <- polling_place_2pp %>% 
  filter(!is.na(TotalVotes))
```

```{r}
polling_place_2pp_clean %>% 
  summarise_all(funs(sum(is.na(.))))
```

Which polling stations have missing data? Not too concerned about post code, as there are some special booths

```{r}
polling_place_2pp_clean %>% 
  filter(is.na(median_age)|is.na(Latitude))
```
Looks like mobile teams and prepoll centres, and only latitude and longitude. Will remove the Brand mobile team, as the demographic data does not look valid.

```{r}
polling_place_2pp_clean<- polling_place_2pp_clean %>% 
  filter(pp_id != 65161)
```



# Visualising Basic Statistics
```{r}
polling_place_2pp_clean %>% 
  ggplot(aes(x = LNP_Percent/100)) + geom_density(colour = 'blue') + 
  theme_classic(base_size = 16) +
  scale_x_continuous(labels=scales::percent) +
  labs(title = '2016 Election: LNP 2 Party Preferred Percentage', x = '2PP Percentage', 
       y = 'Frequency', subtitle = 'by Polling Booth, Unweighted')
```

```{r}
polling_place_2pp_clean %>% 
  ggplot(aes(x = ALP_Percent/100)) + geom_density(colour = 'red') + 
  theme_classic(base_size = 16) +
  scale_x_continuous(labels=scales::percent) +
  labs(title = '2016 Election: ALP 2 Party Preferred Percentage', x = '2PP Percentage', 
       y = 'Frequency', subtitle = 'by Polling Booth, Unweighted')
```

```{r}
polling_place_2pp_clean %>% 
  ggplot(aes(x = Swing/100)) + geom_density(colour = 'purple') + 
  theme_classic(base_size = 16) +
  scale_x_continuous(labels=scales::percent) +
  labs(title = '2016 Election: Swing to Incumbent', x = 'Swing', 
       y = 'Frequency', subtitle = 'by Polling Booth, Unweighted')
```

## State Breakdowns

Can we look at these distributions by state?

```{r}
polling_place_2pp_clean %>% 
  ggplot(aes(x = ALP_Percent/100, colour = StateAb)) + geom_density() + 
  theme_classic(base_size = 16) + scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(labels=scales::percent) +
  labs(title = '2016 Election: ALP 2 Party Preferred Percentage', x = '2PP Percentage', 
       y = 'Frequency', subtitle = 'by Polling Booth, Unweighted')
```

What about by median income

```{r, fig.width=800, fig.height=1600}
polling_place_2pp_clean %>% 
  ggplot(aes(x = ALP_Percent/100, y = median_household_income)) + 
  geom_point() + 
  theme_classic(base_size = 16) + scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(labels=scales::percent) +
  scale_y_continuous(labels=scales::dollar) +
  labs(title = '2016 Election: ALP 2 Party Preferred Percentage', x = '2PP Percentage', 
       y = 'Frequency', subtitle = 'by Polling Booth, Unweighted')+
  facet_wrap(~StateAb, nrow = 4)
```